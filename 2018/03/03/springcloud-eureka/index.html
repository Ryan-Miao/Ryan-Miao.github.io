<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SpringCloud入门1-服务注册与发现(Eureka) | Ryan Miao的博客</title><meta name="keywords" content="SpringCloud,Eureka,服务治理"><meta name="author" content="Ryan Miao"><meta name="copyright" content="Ryan Miao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="前言Oracle转让Java，各种动态语言的曝光率上升，Java工程师的未来在哪里？我觉得Spring Cloud让未来有无限可能。拖了半年之久的Spring Cloud学习就从今天开始了。中文教材不多，而且大多都是简单的离散的信息，想要找到企业级的一体化解决方案很少。不过，对于入门来说，简单就够了，等到用的时候自然而然的汇总起来。 目标是把springcloud的子项目过一遍。 |Compone">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud入门1-服务注册与发现(Eureka)">
<meta property="og:url" content="http://blog.rmiao.top/2018/03/03/springcloud-eureka/index.html">
<meta property="og:site_name" content="Ryan Miao的博客">
<meta property="og:description" content="前言Oracle转让Java，各种动态语言的曝光率上升，Java工程师的未来在哪里？我觉得Spring Cloud让未来有无限可能。拖了半年之久的Spring Cloud学习就从今天开始了。中文教材不多，而且大多都是简单的离散的信息，想要找到企业级的一体化解决方案很少。不过，对于入门来说，简单就够了，等到用的时候自然而然的汇总起来。 目标是把springcloud的子项目过一遍。 |Compone">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg">
<meta property="article:published_time" content="2018-03-02T18:38:15.000Z">
<meta property="article:modified_time" content="2020-11-10T13:25:51.148Z">
<meta property="article:author" content="Ryan Miao">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="Eureka">
<meta property="article:tag" content="服务治理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://blog.rmiao.top/2018/03/03/springcloud-eureka/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-11-10 21:25:51'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">92</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">60</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">42</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ryan Miao的博客</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">SpringCloud入门1-服务注册与发现(Eureka)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2018-03-02T18:38:15.000Z" title="Created 2018-03-03 02:38:15">2018-03-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-11-10T13:25:51.148Z" title="Updated 2020-11-10 21:25:51">2020-11-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringCloud/">SpringCloud</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Oracle转让Java，各种动态语言的曝光率上升，Java工程师的未来在哪里？我觉得Spring Cloud让未来有无限可能。拖了半年之久的Spring Cloud学习就从今天开始了。中文教材不多，而且大多都是简单的离散的信息，想要找到企业级的一体化解决方案很少。不过，对于入门来说，简单就够了，等到用的时候自然而然的汇总起来。</p>
<p>目标是把springcloud的子项目过一遍。</p>
<p>|Component|    Edgware.SR2    |Finchley.M7|    Finchley.BUILD-SNAPSHOT|<br>|—|—|—|—|—|<br>|spring-cloud-aws|    1.2.2.RELEASE|    2.0.0.M4|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-bus|    1.3.2.RELEASE|    2.0.0.M6|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-cli|    1.4.1.RELEASE|    2.0.0.M1|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-commons|    1.3.2.RELEASE|    2.0.0.M7|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-contract    |1.2.3.RELEASE|    2.0.0.M7|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-config|    1.4.2.RELEASE|    2.0.0.M7|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-netflix|    1.4.3.RELEASE|    2.0.0.M7|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-security|    1.2.2.RELEASE|    2.0.0.M2|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-cloudfoundry|    1.1.1.RELEASE|    2.0.0.M3|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-consul|    1.3.2.RELEASE|    2.0.0.M6|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-sleuth|    1.3.2.RELEASE|    2.0.0.M7|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-stream|    Ditmars.SR3|    Elmhurst.RC1|    Elmhurst.BUILD-SNAPSHOT|<br>|spring-cloud-zookeeper|    1.2.0.RELEASE|    2.0.0.M6|    2.0.0.BUILD-SNAPSHOT|<br>|spring-boot|    1.5.10.RELEASE|    2.0.0.RC2|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-task|    1.2.2.RELEASE|    2.0.0.M3|    2.0.0.RELEASE|<br>|spring-cloud-vault|    1.1.0.RELEASE|    2.0.0.M6|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-gateway|    1.0.1.RELEASE|    2.0.0.M7|    2.0.0.BUILD-SNAPSHOT|<br>|spring-cloud-openfeign|    |     2.0.0.M1|    2.0.0.BUILD-SNAPSHOT|</p>
<p>本次学习服务注册与发现， Eureka。</p>
<a id="more"></a>

<h2 id="Eureka介绍"><a href="#Eureka介绍" class="headerlink" title="Eureka介绍"></a>Eureka介绍</h2><p>Eureka是一个基于REST(Representational State Transfer)的服务，主要用于AWS cloud， 提供服务定位(locating services)、负载均衡(load balancing)、故障转移(failover of middle-tier servers)。我们把它叫做<strong>Eureka Server</strong>. Eureka也提供了基于Java的客户端组件，<strong>Eureka Client</strong>,内置的负载均衡器可以实现基本的round-robin负载均衡能力。在Netflix，一个基于Eureka的更复杂的负载均衡器针对多种因素(如流量、资源利用率、错误状态等)提供加权负载均衡，以实现高可用(superior resiliency).</p>
<h3 id="为什么需要Eureka"><a href="#为什么需要Eureka" class="headerlink" title="为什么需要Eureka"></a>为什么需要Eureka</h3><p>在AWS Cloud，由于其天生的特性，服务器经常变换。我们知道每个EC2挂掉后，重启又是一个新的。不像传统的固定IP，AWS的服务器是变化的。因此需要更复杂的负载均衡方案来动态注册和注销。由于AWS并没有提供中间层负载均衡解决方案，Eureka填补了这个领域的巨大空白。</p>
<h3 id="Eureka和AWS-ELB有什么不同"><a href="#Eureka和AWS-ELB有什么不同" class="headerlink" title="Eureka和AWS ELB有什么不同"></a>Eureka和AWS ELB有什么不同</h3><p>AWS ELB(Elastic Load Balancer)是面向最终用户Web流量的边缘服务的负载均衡解决方案。Eureka填补了对中间层负载均衡的需求。理论上，你可以把中间层服务放在AWS ELB之后，但在EC2模型中，你将会把他们直接暴露到外网，从而失去了AWS security groups的好处。(这里有疑问，我现实使用的时候ELB也有区分VPC的，所以不会暴露到外网，不知道是不是本文发布的时候AWS还没这功能，所以感觉Eureka和ELB区别不大啊)。</p>
<p>AWS ELB也是一种传统的基于代理的负载平衡解决方案，而Eureka则不同之处在于负载平衡发生在实例/服务器/主机级别。客户端实例知道他们需要与哪些服务器交互的所有信息。这样的好坏取决于你怎么看待它。如果你想要AWS现在提供的基于粘滞用户session的负载均衡，Eureka没有开箱即用的解决方案。在Netflix，我们更喜欢我们的服务是无状态的(非粘性)。这有利于提供更好的扩展性，Eureka非常适合解决这个问题。(感觉这段也是吹水，现在的web交互大都是无状态的，状态通过redis，message queue等第三方维护，ELB照样可以提供)。</p>
<p>使用Eureka区分基于代理的负载平衡和负载平衡的另一个重要方面是，<strong>您的应用程序可以灵活地处理负载平衡器的中断，因为有关可用服务器的信息会缓存在客户端上。这确实需要少量的内存，但换得更好的弹性。</strong></p>
<h3 id="Eureka和Route-53有什么不同"><a href="#Eureka和Route-53有什么不同" class="headerlink" title="Eureka和Route 53有什么不同"></a>Eureka和Route 53有什么不同</h3><p>Route 53是一个域名服务，就像Eureka可以为中层服务器提供相同的服务一样，但仅此而已。 Route 53是一项DNS服务，即使对于非AWS数据中心，也可以托管您的DNS记录。 Route 53还可以在AWS区域间执行基于延迟的路由。Eureka类似于内部DNS，与全世界的DNS服务器无关。Eureka也是区域隔离的，因为它不知道其他AWS区域中的服务器。保存信息的主要目的是在区域内进行负载平衡。</p>
<p>虽然你可以在Route 53中注册你的中间层服务器，并依赖AWS安全组保护你的服务器不受外网访问，但你的中间层服务器身份仍然暴露于外网环境。它同样带有传统基于DNS的负载均衡方案的缺点，其中流量仍然会被路由到已经不健康或已经不存在的服务器上（在AWS云中，服务器随时可能消失）。</p>
<h3 id="Eureka如何使用？"><a href="#Eureka如何使用？" class="headerlink" title="Eureka如何使用？"></a>Eureka如何使用？</h3><p>在Netflix，Eureka不仅是中间层负载均衡关键部分，还有以下功能：</p>
<p>与Netflix Asgard一起提供红/黑部署服务， Asgard是一个让云部署更方便的开源服务。Eureka会与Asgard搭配，让应用在新/老版本部署切换，让故障处理更快速和无缝，尤其是当启动100个实例部署时要花费很长时间的时候。</p>
<p>当我们的cassandra需要维护时，停止Cassandra实例。</p>
<p>为我们的memcached缓存服务提供识别环上实例列表功能。</p>
<p>为特定的应用提供因意外导致故障保存元信息的服务。</p>
<h3 id="Eureka使用时机？"><a href="#Eureka使用时机？" class="headerlink" title="Eureka使用时机？"></a>Eureka使用时机？</h3><p>当你的服务运行在AWS云上并且你不希望使用AWS ELB注册或暴露给外网。你要么需要使用类似round-robin这种简单的负载均衡方案或者想要写一个基于Eureka包装过的符合要求的负载均衡器。你没有session粘性，没有session绑定机制和在外部缓存(例如 memcached)载入会话数据的需要。更重要的是，如果你的架构风格适合一个基于客户端的负载均衡模型，Eureka相当适合这个场景。</p>
<p>应用客户端和应用服务端如何通信？</p>
<p>通信技术可以是任何你喜欢的。Eureka帮你找到你需要通信的服务信息但没有引入任何通信协议或方法的限制。比如，你可以用Eureka获取目标服务器地址并使用thrift,http(s)或其他RPC机制的协议。</p>
<h3 id="Eureka架构"><a href="#Eureka架构" class="headerlink" title="Eureka架构"></a>Eureka架构</h3><p><img src="https://raw.githubusercontent.com/Netflix/eureka/master/images/eureka_architecture.png"><br>上面的架构图描述了Eureka是如何在Netflix部署的，这也是Eureka集群的运行方式。在每个区域（region）都有一个eureka集群，它只知道该区域内的实例信息。每个分区（zone）至少有一个eureka服务器来处理本分区故障。</p>
<p>服务注册在Eureka上并且每30秒发送心跳来续租。如果一个客户端在几次内没有刷新心跳，它将在大约90秒内被移出服务器注册表。注册信息和更新信息会在整个eureka集群的节点进行复制。任何分区的客户端都可查找注册中心信息（每30秒发生一次）来定位他们的服务（可能会在任何分区）并进行远程调用。</p>
<h3 id="非Java服务和客户端"><a href="#非Java服务和客户端" class="headerlink" title="非Java服务和客户端"></a>非Java服务和客户端</h3><p>对于非Java的服务，你可以用其他语言实现eureka的客户端部分。基于REST的服务也暴露给了所有操作给Eureka客户端。非Java客户端也可以使用REST服务来查询其他服务的信息。</p>
<h3 id="可配置"><a href="#可配置" class="headerlink" title="可配置"></a>可配置</h3><p>有了Eureka，你可以动态添加删除集群节点。你可以调整内部配置，从超时到线程池。Eureka使用archaius并且如果你有一个配置源的实现，那么很多配置可以动态调优。</p>
<h3 id="弹性"><a href="#弹性" class="headerlink" title="弹性"></a>弹性</h3><p>在AWS云中，构建弹性伸缩必不可少。Eureka是我们经验的结晶，并且在客户端和服务端都内置了弹性能力。</p>
<p>Eureka客户端设计成可以处理一个或多个Eureka服务端的失败场景。由于Eureka客户端有注册表缓存信息，即使所有的eureka服务器都挂了，服务也能正常运行。</p>
<p>Eureka服务器对于其他eureka节点挂了也提供了足够的弹性。即使服务端和客户端之间产生了网络分区，服务器也由内置的弹性策略来防止大规模的停机。</p>
<h3 id="多区域"><a href="#多区域" class="headerlink" title="多区域"></a>多区域</h3><p>在多个AWS区域部署Eureka是一个很简单的工作。不同区域之间Eureka集群并不通信。</p>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>Eureka使用servo来跟踪服务端和客户端的信息，包括性能，监控和报警。数据保存在JMX中并暴露给Amazon Cloud Watch。</p>
<hr>
<h2 id="Eureka服务治理体系"><a href="#Eureka服务治理体系" class="headerlink" title="Eureka服务治理体系"></a>Eureka服务治理体系</h2><p>以下参考<a target="_blank" rel="noopener" href="http://blog.csdn.net/sunhuiliang85/article/details/76222517">《Spring Cloud Eureka详解》</a>, 作者 大道化简</p>
<p>大概读完Eureka的简介，应该可以知道Eureka是负责微服务架构中服务治理的功能，负责各个微服务实例的自动注册和发现。</p>
<p>盗图一张, 画的很好。  </p>
<p><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-archi.png-f"></p>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>在服务治理框架中，通常都会构建一个注册中心，每个服务单元向注册中心登记自己提供的服务，包括服务的主机与端口号、服务版本号、通讯协议等一些附加信息。注册中心按照服务名分类组织服务清单，同时还需要以心跳检测的方式去监测清单中的服务是否可用，若不可用需要从服务清单中剔除，以达到排除故障服务的效果。</p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>在服务治理框架下，服务间的调用不再通过指定具体的实例地址来实现，而是通过服务名发起请求调用实现。服务调用方通过服务名从服务注册中心的服务清单中获取服务实例的列表清单，通过指定的负载均衡策略取出一个服务实例位置来进行服务调用。</p>
<h3 id="Eureka服务端"><a href="#Eureka服务端" class="headerlink" title="Eureka服务端"></a>Eureka服务端</h3><p>Eureka服务端，即服务注册中心。它同其他服务注册中心一样，支持高可用配置。依托于强一致性提供良好的服务实例可用性，可以应对多种不同的故障场景。</p>
<p>Eureka服务端支持集群模式部署，当集群中有分片发生故障的时候，Eureka会自动转入自我保护模式。它允许在分片发生故障的时候继续提供服务的发现和注册，当故障分配恢复时，集群中的其他分片会把他们的状态再次同步回来。集群中的的不同服务注册中心通过异步模式互相复制各自的状态，这也意味着在给定的时间点每个实例关于所有服务的状态可能存在不一致的现象。</p>
<h3 id="Eureka客户端"><a href="#Eureka客户端" class="headerlink" title="Eureka客户端"></a>Eureka客户端</h3><p>Eureka客户端，主要处理服务的注册和发现。客户端服务通过注册和参数配置的方式，嵌入在客户端应用程序的代码中。在应用程序启动时，Eureka客户端向服务注册中心注册自身提供的服务，并周期性的发送心跳来更新它的服务租约。同时，他也能从服务端查询当前注册的服务信息并把它们缓存到本地并周期行的刷新服务状态。</p>
<hr>
<h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><p>在服务治理框架中，通常都会构建一个注册中心，每个服务单元向注册中心登记自己提供的服务，包括服务的主机与端口号、服务版本号、通讯协议等一些附加信息。注册中心按照服务名分类组织服务清单，同时还需要以心跳检测的方式去监测清单中的服务是否可用，若不可用需要从服务清单中剔除，以达到排除故障服务的效果。</p>
<h3 id="创建Eureka-Server"><a href="#创建Eureka-Server" class="headerlink" title="创建Eureka Server"></a>创建Eureka Server</h3><p>测试代码： <a target="_blank" rel="noopener" href="https://github.com/Ryan-Miao/eureka-server">https://github.com/Ryan-Miao/eureka-server</a></p>
<p>Eureka Server是基于springboot的，只要启动一个springboot就可以了。start.spring.io提供了一系列启动模板，而且Spring又和Idea比较暧昧，所以使用Idea可以超级简单的搭建和集成Spring项目。</p>
<p>在Idea里，新建项目，选择Spring initializer.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2279594-de33b84a79858106.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600"></p>
<p>然后，勾选你想要的组件就行了。这里搜索Eureka Server, 选择</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2279594-3addb73d569a58e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/600"></p>
<p>当然，创建好项目后记得先修改编码为UTF8, 不然万恶的GBK…</p>
<p>我的pom如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.test<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>eureka-server<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Edgware.SR2<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>然后，在application.properties中加入配置信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name&#x3D;eureka-server</span><br><span class="line"></span><br><span class="line">#服务注册中心端口号</span><br><span class="line">server.port&#x3D;1110</span><br><span class="line"></span><br><span class="line">#服务注册中心实例的主机名</span><br><span class="line">eureka.instance.hostname&#x3D;localhost</span><br><span class="line"></span><br><span class="line">#是否向服务注册中心注册自己</span><br><span class="line">eureka.client.register-with-eureka&#x3D;false</span><br><span class="line"></span><br><span class="line">#是否检索服务</span><br><span class="line">eureka.client.fetch-registry&#x3D;false</span><br><span class="line"></span><br><span class="line">#服务注册中心的配置内容，指定服务注册中心的位置</span><br><span class="line">eureka.client.serviceUrl.defaultZone&#x3D;http:&#x2F;&#x2F;$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>


<p>修改启动类，添加<code>@EnableEurekaServer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(EurekaServerApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<p>然后，启动main方法即可。如果端口有冲突，修改合适的端口重启。demo中端口为1110，启动后，访问<a target="_blank" rel="noopener" href="http://localhost:1110/">http://localhost:1110/</a> 可以看到状态控制台。</p>
<p>前文也说了，上述demo是注册中心，所有的微服务要向本server注册以实现负载均衡。那么，首先就要保证注册中心的稳定，于是就必须搭建Eureka集群的高可用方案。</p>
<h2 id="高可用服务注册中心"><a href="#高可用服务注册中心" class="headerlink" title="高可用服务注册中心"></a>高可用服务注册中心</h2><p>考虑到发生故障的情况，服务注册中心发生故障必将会造成整个系统的瘫痪，因此需要保证服务注册中心的高可用。</p>
<p>Eureka Server在设计的时候就考虑了高可用设计，在Eureka服务治理设计中，所有节点既是服务的提供方，也是服务的消费方，服务注册中心也不例外。</p>
<p>Eureka Server的高可用实际上就是将自己做为服务向其他服务注册中心注册自己，这样就可以形成一组互相注册的服务注册中心，以实现服务清单的互相同步，达到高可用的效果。</p>
<h3 id="构建服务注册中心集群"><a href="#构建服务注册中心集群" class="headerlink" title="构建服务注册中心集群"></a>构建服务注册中心集群</h3><p>Eureka Server的同步遵循着一个非常简单的原则：只要有一条边将节点连接，就可以进行信息传播与同步。可以采用两两注册的方式实现集群中节点完全对等的效果，实现最高可用性集群，任何一台注册中心故障都不会影响服务的注册与发现.</p>
<p><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-invoke.png-f"></p>
<p>所以，下面创建3个Eureka Server两两互相注册，形成集群。由于核心代码一样，我们只要将其部署在不同的机器上即可。因此，我需要3个不同的配置文件。</p>
<p>为了本地模拟，修改host，虚拟3个域名</p>
<p>windows host 位置<code>C:\Windows\System32\drivers\etc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 master</span><br><span class="line">127.0.0.1 backup1</span><br><span class="line">127.0.0.1 backup2</span><br></pre></td></tr></table></figure>


<p>然后，给我们的Eureka Server增加3个配置文件。此时，应该将application.properties里除了spring.application.name之外的配置注释掉，我们后面3个配置暂时不用上面几个开关。</p>
<p>application-peer1.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server.port&#x3D;1111</span><br><span class="line"></span><br><span class="line">eureka.instance.hostname&#x3D;master</span><br><span class="line"></span><br><span class="line">eureka.client.serviceUrl.defaultZone&#x3D;http:&#x2F;&#x2F;backup1:1112&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;backup2:1113&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>


<p>application-peer2.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.port&#x3D;1112</span><br><span class="line"></span><br><span class="line">eureka.instance.hostname&#x3D;backup1</span><br><span class="line"></span><br><span class="line">eureka.client.serviceUrl.defaultZone&#x3D;http:&#x2F;&#x2F;master:1111&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;backup2:1113&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>



<p>application-peer3.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server.port&#x3D;1113</span><br><span class="line"></span><br><span class="line">eureka.instance.hostname&#x3D;backup2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eureka.client.serviceUrl.defaultZone&#x3D;http:&#x2F;&#x2F;master:1111&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;backup1:1112&#x2F;eureka&#x2F;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<p>由于是本地开发环境，我们直接以maven启动。当然，也可以选择jar启动。</p>
<p>分别打开3个命令行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dspring.profiles.active&#x3D;peer1</span><br><span class="line">mvn spring-boot:run -Dspring.profiles.active&#x3D;peer2</span><br><span class="line">mvn spring-boot:run -Dspring.profiles.active&#x3D;peer3</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>注意，由于启动的时候会去指定zone注册，而另外的server还没启动，这时候会报错，<code>Cannot execute request on any known server</code>, 不用理会，接着启动后两个即可。</p>
<p>全部启动成功后，访问<a target="_blank" rel="noopener" href="http://master:1111/">http://master:1111/</a></p>
<p><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-info.png"></p>
<p>可以看到2个备份，在线的server有3个Availability Zones。Availability Zones在AWS中是指可用区，是在不同region里的不同机房。</p>
<p>注册中心高可用集群demo搭建完毕。</p>
<h3 id="失效剔除"><a href="#失效剔除" class="headerlink" title="失效剔除"></a>失效剔除</h3><p>有些时候，我们的服务实例并不一定会正常下线，可能由于内存溢出、网络故障等原因使服务不能正常运作。而服务注册中心并未收到“服务下线”的请求，为了从服务列表中将这些无法提供服务的实例剔除，Eureka Server在启动的时候会创建一个定时任务，默认每隔一段时间（默认为60秒）将当前清单中超时（默认为90秒）没有续约的服务剔除出去。</p>
<h3 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h3><p>服务注册到Eureka Server后，会维护一个心跳连接，告诉Eureka Server自己还活着。Eureka Server在运行期间会统计心跳失败的比例在15分钟以之内是否低于85%，如果出现低于的情况，Eureka Server会将当前实例注册信息保护起来，让这些实例不会过期。这样做会使客户端很容易拿到实际已经不存在的服务实例，会出现调用失败的情况。因此客户端要有容错机制，比如请求重试、断路器。</p>
<p>以下是自我保护相关的属性：</p>
<p>eureka.server.enableSelfPreservation=true. 可以设置改参数值为false，以确保注册中心将不可用的实例删除</p>
<h3 id="region（地域）与zone（可用区）"><a href="#region（地域）与zone（可用区）" class="headerlink" title="region（地域）与zone（可用区）"></a>region（地域）与zone（可用区）</h3><p>region和zone（或者Availability Zone）均是AWS的概念。在非AWS环境下，我们可以简单地将region理解为地域，zone理解成机房。一个region可以包含多个zone，可以理解为一个地域内的多个不同的机房。不同地域的距离很远，一个地域的不同zone间距离往往较近，也可能在同一个机房内。</p>
<p>region可以通过配置文件进行配置，如果不配置，会默认使用us-east-1。同样Zone也可以配置，如果不配置，会默认使用defaultZone。</p>
<p>Eureka Server通过eureka.client.serviceUrl.defaultZone属性设置Eureka的服务注册中心的位置。</p>
<p>指定region和zone的属性如下：</p>
<p>（1）eureka.client.availabilityZones.myregion=myzone# myregion是region</p>
<p>（2）eureka.client.region=myregion</p>
<p>Ribbon的默认策略会优先访问通客户端处于同一个region中的服务端实例，只有当同一个zone中没有可用服务端实例的时候才会访问其他zone中的实例。所以通过zone属性的定义，配合实际部署的物理结构，我们就可以设计出应对区域性故障的容错集群。</p>
<h3 id="安全验证"><a href="#安全验证" class="headerlink" title="安全验证"></a>安全验证</h3><p>刚才的demo中，我们注册中心的面板是公开访问的。这里可以简单加入用户名密码，让访问更安全。当然，你可以自己实现sso。<br>pom添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>然后，为了简单演示，事实上也应该这样。我们将3个server的用户名密码设置一致。即，在application.properties里添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security.user.name&#x3D;admin</span><br><span class="line">security.user.password&#x3D;123456</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>然后，在我们其他三个配置文件中的<code>eureka.client.serviceUrl.defaultZone</code>添加自己的url并加入用户名密码，<br>以peer1为例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.serviceUrl.defaultZone&#x3D;http:&#x2F;&#x2F;$&#123;security.user.name&#125;:$&#123;security.user.password&#125;@$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;backup1:1112&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;backup2:1113&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>











<hr>
<h2 id="服务提供者-微服务集群"><a href="#服务提供者-微服务集群" class="headerlink" title="服务提供者 微服务集群"></a>服务提供者 微服务集群</h2><h3 id="服务注册-1"><a href="#服务注册-1" class="headerlink" title="服务注册"></a>服务注册</h3><p>服务提供者在启动的时候会通过REST请求的方式将自己注册到Eureka Server上，同时带上自身服务的一些元数据信息。Eureka Server接收到这个Rest请求之后，将元数据信息存储在一个双层结构的Map中，其中第一层的key是服务名。第二层的key 是具体服务的实例名。</p>
<p>在服务注册时，需要确认一下eureka.client.register-with-eureka=true参数是否正确，该值默认为true。若设置为fasle将不会启动注册操作。</p>
<h3 id="服务同步"><a href="#服务同步" class="headerlink" title="服务同步"></a>服务同步</h3><p>从eureka服务治理体系架构图中可以看到，不同的服务提供者可以注册在不同的服务注册中心上，它们的信息被不同的服务注册中心维护。</p>
<p>此时，由于多个服务注册中心互相注册为服务，当服务提供者发送注册请求到一个服务注册中心时，它会将该请求转发给集群中相连的其他注册中心，从而实现服务注册中心之间的服务同步。通过服务同步，提供者的服务信息就可以通过集群中的任意一个服务注册中心获得。</p>
<h3 id="服务续约"><a href="#服务续约" class="headerlink" title="服务续约"></a>服务续约</h3><p>在注册服务之后，服务提供者会维护一个心跳用来持续高速Eureka Server，“我还在持续提供服务”，否则Eureka Server的剔除任务会将该服务实例从服务列表中排除出去。我们称之为服务续约。</p>
<p>下面是服务续约的两个重要属性：</p>
<p>（1）<code>eureka.instance.lease-expiration-duration-in-seconds</code></p>
<p>leaseExpirationDurationInSeconds，表示eureka server至上一次收到client的心跳之后，等待下一次心跳的超时时间，在这个时间内若没收到下一次心跳，则将移除该instance。</p>
<p>默认为90秒</p>
<p>如果该值太大，则很可能将流量转发过去的时候，该instance已经不存活了。<br>如果该值设置太小了，则instance则很可能因为临时的网络抖动而被摘除掉。<br>该值至少应该大于leaseRenewalIntervalInSeconds</p>
<p>（2）<code>eureka.instance.lease-renewal-interval-in-seconds</code></p>
<p>leaseRenewalIntervalInSeconds，表示eureka client发送心跳给server端的频率。如果在leaseExpirationDurationInSeconds后，server端没有收到client的心跳，则将摘除该instance。除此之外，如果该instance实现了HealthCheckCallback，并决定让自己unavailable的话，则该instance也不会接收到流量。</p>
<p>默认30秒</p>
<h3 id="创建并注册服务提供者-Eureka-Client"><a href="#创建并注册服务提供者-Eureka-Client" class="headerlink" title="创建并注册服务提供者 Eureka Client"></a>创建并注册服务提供者 Eureka Client</h3><p>项目代码： <a target="_blank" rel="noopener" href="https://github.com/Ryan-Miao/eureka-client">https://github.com/Ryan-Miao/eureka-client</a></p>
<p>Eureka Server是注册中心，我们的客户端也要集成Eureka client来自我注册。我们client项目也是基于Springboot的。同样创建一个新的项目 eureka-client. 这次，要引入Eureka Discovery以及健康检查Actuator。最终pom如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">	xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">	&lt;groupId&gt;com.test&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;eureka-client&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">	&lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">	&lt;name&gt;eureka-client&lt;/name&gt;</span><br><span class="line">	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;1.5.10.RELEASE&lt;/version&gt;</span><br><span class="line">		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">		&lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">		&lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">		&lt;spring-cloud.version&gt;Edgware.SR2&lt;/spring-cloud.version&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">			&lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dependencyManagement&gt;</span><br><span class="line">		&lt;dependencies&gt;</span><br><span class="line">			&lt;dependency&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">				&lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">				&lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">			&lt;/dependency&gt;</span><br><span class="line">		&lt;/dependencies&gt;</span><br><span class="line">	&lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>然后，启动类添加<code>@EnableDiscoveryClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(EurekaClientApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>最后，添加配置信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name&#x3D;eureka-client-service-provider</span><br><span class="line">server.port&#x3D;2001</span><br><span class="line">eureka.client.serviceUrl.defaultZone&#x3D;http:&#x2F;&#x2F;admin:123456@master:1111&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;admin:123456@backup1:1112&#x2F;eureka&#x2F;,http:&#x2F;&#x2F;admin:123456@backup2:1113&#x2F;eureka&#x2F;</span><br></pre></td></tr></table></figure>



<p>这里，我们把三个注册中心的地址都加上。然后，为保证高可用，我们的服务提供者也需要集群部署。真实生产环境中肯定是部署到不同的机器上，在本地模拟的话，我们只好以不同端口来模拟了。</p>
<p>启动端口2001</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dserver.port&#x3D;2001</span><br></pre></td></tr></table></figure>
<p>启动端口2002</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run -Dserver.port&#x3D;2002</span><br></pre></td></tr></table></figure>

<p>然后，查看注册中心面板。<br><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-client-provider.png"></p>
<hr>
<h2 id="服务消费者-另一个微服务集群"><a href="#服务消费者-另一个微服务集群" class="headerlink" title="服务消费者 另一个微服务集群"></a>服务消费者 另一个微服务集群</h2><h3 id="获取服务"><a href="#获取服务" class="headerlink" title="获取服务"></a>获取服务</h3><p>消费者服务启动时，会发送一个Rest请求给服务注册中心，来获取上面注册的服务清单。为了性能考虑，Eureka Server会维护一份只读的服务注册清单来返回给客户端，同时该缓存清单默认会每隔30秒更新一次。</p>
<p>下面是获取服务的两个重要的属性：</p>
<p>（1）      <code>eureka.client.fetch-registry</code></p>
<p>是否需要去检索寻找服务，默认是true</p>
<p>（2）<code>eureka.client.registry-fetch-interval-seconds</code></p>
<p>表示eureka client间隔多久去拉取服务注册信息，默认为30秒，对于api-gateway，如果要迅速获取服务注册状态，可以缩小该值，比如5秒</p>
<h3 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h3><p>服务消费者在获取服务清单后，通过服务名可以获取具体提供服务的实例名和该实例的元数据信息。因为有这些服务实例的详细信息，所以客户端可以根据自己的需要决定具体调用哪个实例，在Ribbon中会默认采用轮询的方式进行调用，从而实现客户端的负载均衡。</p>
<p>等学到Ribbon之后再继续服务消费。</p>
<h3 id="服务下线"><a href="#服务下线" class="headerlink" title="服务下线"></a>服务下线</h3><p>在系统运行过程中必然会面临关闭或重启服务的某个实例的情况，在服务关闭操作时，会触发一个服务下线的Rest服务请求给Eureka Server，告诉服务注册中心：“我要下线了。”服务端在接收到该请求后，将该服务状态置位下线（DOWN），并把该下线事件传播出去。</p>
<h2 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h2><p><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-config.png"></p>
<h2 id="服务实例类配置"><a href="#服务实例类配置" class="headerlink" title="服务实例类配置"></a>服务实例类配置</h2><h3 id="端点配置"><a href="#端点配置" class="headerlink" title="端点配置"></a>端点配置</h3><p>eureka实例的状态页面和健康监控的url默认为spring boot actuator提供的/info端点和/health端点。我们必须确保Eureka客户端的/health端点在发送元数据的时候，是一个能够被注册中心访问到的地址，否则服务注册中心不会根据应用的健康检查来更改状态（仅当开启了healthcheck功能时，以该端点信息作为健康检查标准）。而如果/info端点不正确的话，会导致在Eureka面板中单击服务时，无法访问到服务实例提供的信息接口。</p>
<p>大多数情况下，我们不需要修改这个几个url配置。但是当应用不使用默认的上下文(context path或servlet path，比如配置server.servletPath=/test），或者管理终端路径（比如配置management.contextPath=/admin）时，我们需要修改健康检查和状态页的url地址信息。</p>
<p>application.yml配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.context-path&#x3D;&#x2F;helloeureka</span><br></pre></td></tr></table></figure>

<p>//下面配置为相对路径，也支持配置成绝对路径，例如需要支持https</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.health-check-url-path&#x3D;$&#123;server.context-path&#125;&#x2F;health</span><br><span class="line"></span><br><span class="line">eureka.instance.status-page-url-path&#x3D;$&#123;server.context-path&#125;&#x2F;info</span><br></pre></td></tr></table></figure>




<h3 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h3><p>元数据是Eureka客户端在向服务注册中心发送注册请求时，用来描述自身服务信息的对象，其中包含了一些标准化的元数据，比如服务名称、实例名称、实例IP、实例端口等用于服务治理的重要信息；以及一些用于负载均衡策略或是其他特殊用途的自定义元数据信息。</p>
<p>我们可以通过<code>eureka.instance.&lt;properties&gt;=&lt;value&gt;</code>的格式对标准化元数据直接进行配置，其中<code>&lt;properties&gt;</code>就是EurekaInstanceConfigBean对象中的成员变量。而对于自定义元数据，可以通过<code>eureka.instance.metadataMap.&lt;key&gt;=&lt;value&gt;</code>的格式来进行配置。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.metadataMap.zone&#x3D;tianjin</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;随机生成实例名</span><br><span class="line"></span><br><span class="line">eureka.instance.metadataMap.instanceId&#x3D;$&#123;spring.application.name&#125;:$&#123;random.value&#125;</span><br></pre></td></tr></table></figure>


<h3 id="健康检测"><a href="#健康检测" class="headerlink" title="健康检测"></a>健康检测</h3><p>默认情况下，Eureka中各个服务实例的健康检测并不是通过spring-boot-acturator模块的/health端点来实现的，而是依靠客户端心跳的方式来保持服务实例的存活。在Eureka的服务续约与剔除机制下，客户端的健康状态从注册到注册中心开始都会处于UP状态，除非心跳终止一段时间之后，服务注册中心将其剔除。默认的心跳实现方式可以有效检查客户端进程是否正常运作，但却无法保证客户端应用能够正常提供服务。</p>
<p>在Spring Cloud Eureka中，可以把Eureka客户端的健康检测交给spring-boot-actuator模块的health端点，以实现更加全面的健康状态维护，设置方式如下：</p>
<p>（1）      在pom.xml中引入spring-boot-starter-actuator模块的依赖</p>
<p>（2）      在application.properties中增加参数配置<code>eureka.client.healthcheck.enabled=true</code></p>
<p>这里，Idea里并没有提示<code>eureka.client.healthcheck.enabled</code>这个属性，并且还显示黄色，让以为是不是哪里错了，根本不敢尝试。不过百度后，发现有人做了类似实验，成功了。好吧，可能对这个的学习还不够，或者就应该给Idea提一个issue。下面给出自定义health check来替换Eureka自带心跳测试。</p>
<h4 id="自己实现HealthChecker"><a href="#自己实现HealthChecker" class="headerlink" title="自己实现HealthChecker"></a>自己实现HealthChecker</h4><p>根据自己health的定义，自己实现一个HealthChecker。这里简单模拟。<br>在eureka-client创建MyHealthChecker，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHealthChecker</span> <span class="keyword">implements</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> up = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">health</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (up) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Health.Builder().withDetail(<span class="string">&quot;aaa_cnt&quot;</span>, <span class="number">10</span>) <span class="comment">//自定义监控内容</span></span><br><span class="line">                    .withDetail(<span class="string">&quot;bbb_status&quot;</span>, <span class="string">&quot;up&quot;</span>).up().build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Health.Builder().withDetail(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;client is down&quot;</span>).down().build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> up;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">(<span class="keyword">boolean</span> up)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.up = up;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，暴露出一个接口来控制up状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HealthSettingController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyHealthChecker myHealthChecker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/health/&#123;status&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">up</span><span class="params">(<span class="meta">@PathVariable(&quot;status&quot;)</span> Boolean status)</span> </span>&#123;</span><br><span class="line">        myHealthChecker.setUp(status);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> status.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>然后在我们的客户端eureka-clientp配置文件里新增<code>eureka.client.healthcheck.enabled=true</code></p>
<p>重新启动，访问<code>http://localhost:2001/health/false</code>来把我们client端中一个instance设置为down。然后，刷新eureka server面板，即访问<a target="_blank" rel="noopener" href="http://master:1111/%EF%BC%8C">http://master:1111/，</a> 可以看到，我们的client确实下线了。</p>
<p><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-client-down.png"></p>
<h3 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h3><p>除了上述配置参数外，下面整理了一些EurekaInstanceConfigBean中定义的配置参数以及对应的说明和默认值，这些参数均以eureka.instance为前缀。</p>
<p><img src="http://oe20lp6p0.bkt.clouddn.com/blog/2018/eureka-config2.png"></p>
<h2 id="通讯协议"><a href="#通讯协议" class="headerlink" title="通讯协议"></a>通讯协议</h2><p>默认情况下，Eureka使用Jersey和XStream配合JSON作为Server与Client之间的通讯协议。也可以选择实现自己的协议来代替。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance">Eureka at a glance</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1016cae4fc29">Eureka简介</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/sunhuiliang85/article/details/76222517">Spring Cloud Eureka详解</a></li>
<li><a target="_blank" rel="noopener" href="https://projects.spring.io/spring-cloud/">Spring Cloud官网</a></li>
<li><a target="_blank" rel="noopener" href="https://springcloud.cc/spring-cloud-dalston.html#_features">Spring Cloud 中文版</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Ryan Miao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.rmiao.top/2018/03/03/springcloud-eureka/">http://blog.rmiao.top/2018/03/03/springcloud-eureka/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a><a class="post-meta__tags" href="/tags/Eureka/">Eureka</a><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/">服务治理</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2018/03/04/springboot-actuator/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">SpringCloud入门2-Springboot监控模块(actuator)</div></div></a></div><div class="next-post pull-right"><a href="/2018/03/01/consul-install/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">consul安装使用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2018/06/14/springcloud2-eureka/" title="SpringCloud2.0入门3-新的eureka依赖"><img class="cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-14</div><div class="title">SpringCloud2.0入门3-新的eureka依赖</div></div></a></div><div><a href="/2018/06/14/springcloud2-admin/" title="SpringCloud2.0入门4-springboot-admin监控"><img class="cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-06-14</div><div class="title">SpringCloud2.0入门4-springboot-admin监控</div></div></a></div><div><a href="/2018/03/01/consul-install/" title="consul安装使用"><img class="cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-01</div><div class="title">consul安装使用</div></div></a></div><div><a href="/2018/07/04/springcloud-provider/" title="SpringCloud学习5-如何创建一个服务提供者provider"><img class="cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-07-04</div><div class="title">SpringCloud学习5-如何创建一个服务提供者provider</div></div></a></div><div><a href="/2018/03/04/springboot-actuator/" title="SpringCloud入门2-Springboot监控模块(actuator)"><img class="cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-03-04</div><div class="title">SpringCloud入门2-Springboot监控模块(actuator)</div></div></a></div><div><a href="/2018/07/04/springcloud-consumer/" title="SpringCloud学习6-如何创建一个服务消费者consumer"><img class="cover" src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2018-07-04</div><div class="title">SpringCloud学习6-如何创建一个服务消费者consumer</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Ryan Miao</div><div class="author-info__description">技术总结</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">92</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">60</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">42</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/ryan-miao" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:woshimrf@126.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">Eureka介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81Eureka"><span class="toc-number">2.1.</span> <span class="toc-text">为什么需要Eureka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E5%92%8CAWS-ELB%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E5%90%8C"><span class="toc-number">2.2.</span> <span class="toc-text">Eureka和AWS ELB有什么不同</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E5%92%8CRoute-53%E6%9C%89%E4%BB%80%E4%B9%88%E4%B8%8D%E5%90%8C"><span class="toc-number">2.3.</span> <span class="toc-text">Eureka和Route 53有什么不同</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="toc-number">2.4.</span> <span class="toc-text">Eureka如何使用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E4%BD%BF%E7%94%A8%E6%97%B6%E6%9C%BA%EF%BC%9F"><span class="toc-number">2.5.</span> <span class="toc-text">Eureka使用时机？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E6%9E%B6%E6%9E%84"><span class="toc-number">2.6.</span> <span class="toc-text">Eureka架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%9EJava%E6%9C%8D%E5%8A%A1%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.7.</span> <span class="toc-text">非Java服务和客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%85%8D%E7%BD%AE"><span class="toc-number">2.8.</span> <span class="toc-text">可配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B9%E6%80%A7"><span class="toc-number">2.9.</span> <span class="toc-text">弹性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%8C%BA%E5%9F%9F"><span class="toc-number">2.10.</span> <span class="toc-text">多区域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7"><span class="toc-number">2.11.</span> <span class="toc-text">监控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E4%BD%93%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">Eureka服务治理体系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">3.1.</span> <span class="toc-text">服务注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">3.2.</span> <span class="toc-text">服务发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">3.3.</span> <span class="toc-text">Eureka服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eureka%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">3.4.</span> <span class="toc-text">Eureka客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">4.</span> <span class="toc-text">注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAEureka-Server"><span class="toc-number">4.1.</span> <span class="toc-text">创建Eureka Server</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">5.</span> <span class="toc-text">高可用服务注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%9B%86%E7%BE%A4"><span class="toc-number">5.1.</span> <span class="toc-text">构建服务注册中心集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B1%E6%95%88%E5%89%94%E9%99%A4"><span class="toc-number">5.2.</span> <span class="toc-text">失效剔除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E6%88%91%E4%BF%9D%E6%8A%A4"><span class="toc-number">5.3.</span> <span class="toc-text">自我保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#region%EF%BC%88%E5%9C%B0%E5%9F%9F%EF%BC%89%E4%B8%8Ezone%EF%BC%88%E5%8F%AF%E7%94%A8%E5%8C%BA%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">region（地域）与zone（可用区）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E9%AA%8C%E8%AF%81"><span class="toc-number">5.5.</span> <span class="toc-text">安全验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">6.</span> <span class="toc-text">服务提供者 微服务集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C-1"><span class="toc-number">6.1.</span> <span class="toc-text">服务注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%90%8C%E6%AD%A5"><span class="toc-number">6.2.</span> <span class="toc-text">服务同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%BB%AD%E7%BA%A6"><span class="toc-number">6.3.</span> <span class="toc-text">服务续约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85-Eureka-Client"><span class="toc-number">6.4.</span> <span class="toc-text">创建并注册服务提供者 Eureka Client</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85-%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4"><span class="toc-number">7.</span> <span class="toc-text">服务消费者 另一个微服务集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1"><span class="toc-number">7.1.</span> <span class="toc-text">获取服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">7.2.</span> <span class="toc-text">服务调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%BA%BF"><span class="toc-number">7.3.</span> <span class="toc-text">服务下线</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-number">8.</span> <span class="toc-text">配置详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E7%B1%BB%E9%85%8D%E7%BD%AE"><span class="toc-number">9.</span> <span class="toc-text">服务实例类配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E7%82%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">9.1.</span> <span class="toc-text">端点配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">9.2.</span> <span class="toc-text">元数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%B5%8B"><span class="toc-number">9.3.</span> <span class="toc-text">健康检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0HealthChecker"><span class="toc-number">9.3.1.</span> <span class="toc-text">自己实现HealthChecker</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE"><span class="toc-number">9.4.</span> <span class="toc-text">其他配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE"><span class="toc-number">10.</span> <span class="toc-text">通讯协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">11.</span> <span class="toc-text">参考</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/11/11/java-synchronized/" title="Java基础之Synchronized原理"><img src="https://cn.bing.com/th?id=OHR.EsskastanieD_ZH-CN9736686128_UHD.jpg&amp;rf=LaDigue_UHD.jpg&amp;pid=hp&amp;w=2880&amp;h=1620&amp;rs=1&amp;c=4" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java基础之Synchronized原理"/></a><div class="content"><a class="title" href="/2020/11/11/java-synchronized/" title="Java基础之Synchronized原理">Java基础之Synchronized原理</a><time datetime="2020-11-11T12:46:40.000Z" title="Created 2020-11-11 20:46:40">2020-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2018/07/10/java-class-inheritance/" title="Java复习3-类的继承"><img src="https://cn.bing.com/th?id=OHR.LakotaBadlands_ZH-CN0151830089_UHD.jpg&amp;rf=LaDigue_UHD.jpg&amp;pid=hp&amp;w=2880&amp;h=1620&amp;rs=1&amp;c=4" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java复习3-类的继承"/></a><div class="content"><a class="title" href="/2018/07/10/java-class-inheritance/" title="Java复习3-类的继承">Java复习3-类的继承</a><time datetime="2018-07-10T11:58:14.000Z" title="Created 2018-07-10 19:58:14">2018-07-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2018/07/07/java-class/" title="Java复习2-对象与类"><img src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java复习2-对象与类"/></a><div class="content"><a class="title" href="/2018/07/07/java-class/" title="Java复习2-对象与类">Java复习2-对象与类</a><time datetime="2018-07-07T07:27:14.000Z" title="Created 2018-07-07 15:27:14">2018-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2018/07/06/java-data-type/" title="Java复习1-数据类型"><img src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java复习1-数据类型"/></a><div class="content"><a class="title" href="/2018/07/06/java-data-type/" title="Java复习1-数据类型">Java复习1-数据类型</a><time datetime="2018-07-06T09:03:26.000Z" title="Created 2018-07-06 17:03:26">2018-07-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2018/07/04/springcloud-consumer/" title="SpringCloud学习6-如何创建一个服务消费者consumer"><img src="https://cdn.jsdelivr.net/gh/Ryan-Miao/ryan-miao.github.io/image/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud学习6-如何创建一个服务消费者consumer"/></a><div class="content"><a class="title" href="/2018/07/04/springcloud-consumer/" title="SpringCloud学习6-如何创建一个服务消费者consumer">SpringCloud学习6-如何创建一个服务消费者consumer</a><time datetime="2018-07-04T11:44:12.000Z" title="Created 2018-07-04 19:44:12">2018-07-04</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 By Ryan Miao</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '50b74dddd9c8deff00e9',
      clientSecret: 'b61654c092fbd8ab7ff6c4d0078b671b62211e23',
      repo: 'gitalk',
      owner: 'ryanmiao2',
      admin: ['ryanmiao2'],
      id: '86ddc6e929130a2da3bb6efd5c72a3ef',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>